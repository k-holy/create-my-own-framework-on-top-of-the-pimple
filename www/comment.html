<!DOCTYPE html>
<html lang="ja">

<head metal:use-macro="__layout.html/head">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="/bootstrap/css/bootstrap.min.css" />
<script src="/js/jquery-1.9.1.min.js"></script>
<script src="/bootstrap/js/bootstrap.min.js"></script>
<title>投稿フォーム</title>
</head>

<body metal:use-macro="__layout.html/body">

<div class="container">

  <header class="header">
    <h1>投稿フォーム@example.com</h1>
  </header>

  <div class="content" metal:fill-slot="content">

    <div class="alert alert-danger" tal:condition="form/hasError">
      <button class="close" data-dismiss="alert">×</button>
      <span class="glyphicon glyphicon-warning-sign"></span><strong>入力値にエラーがあります</strong>
      <ul>
        <li tal:repeat="error form/getErrors" tal:content="error">名前を入力してください。</li>
      </ul>
    </div>

    <form class="form-horizontal" role="form" method="post" tal:attributes="action server/REQUEST_URI">
      <input type="hidden" name="${token/name}" value="${token/value}" tal:condition="exists:token" />
      <fieldset id="file-upload-fieldset">
        <legend><span class="glyphicon glyphicon -comment"></span>投稿フォーム</legend>
        <input id="file-json" type="hidden" name="image_file_json" value="" tal:attributes="value form/image_file_json/value" />
        <input id="file-input" type="file" name="upload_file" style="visibility:hidden;width:0px;height:0px" />
        <div class="form-group" tal:attributes="class php:form.author.hasError() ? 'form-group has-error' : 'form-group'">
          <label class="col-md-2 control-label">名前</label>
          <div class="col-md-5">
            <input type="text" name="author" class="form-control" tal:attributes="value form/author/value" />
          </div>
          <div class="col-md-5" tal:condition="form/author/hasError">
            <p class="help-block" tal:content="form/author/error">名前を入力してください。</p>
          </div>
        </div>
        <div class="form-group" tal:attributes="class php:form.comment.hasError() ? 'form-group has-error' : 'form-group'">
          <label class="col-md-2 control-label">コメント</label>
          <div class="col-md-5">
            <textarea name="comment" rows="5" class="form-control" tal:content="form/comment/value">コメント内容....</textarea>
          </div>
          <div class="col-md-5" tal:condition="form/comment/hasError">
            <p class="help-block" tal:content="form/comment/error">コメントを入力してください。</p>
          </div>
        </div>
        <div class="form-group">
          <label class="col-md-2 control-label">画像</label>
          <div class="col-md-2">
            <input id="file-input-show" type="text" name="image_file_name" class="form-control" tal:attributes="value php:form.image_file_name.hasValue() ? form.image_file_name : ''" />
            <div id="file-show" style="display:none;" tal:attributes="style php:form.image_data_uri.hasValue() ? '' : 'display:none'">
              <p><img alt="" src="" tal:attributes="src php:form.image_data_uri.hasValue() ? form.image_data_uri : '';alt php:form.image_file_name.hasValue() ? form.image_file_name : ''"/></p>
              <p><a id="file-delete" class="btn btn-sm" href="javascript:void(0)">削除</a></p>
            </div>
          </div>
          <div class="col-md-3">
            <button id="file-select" type="button" class="btn btn-primary btn-sm">ファイルを選択</button>
            <button id="file-upload-button" type="button" class="btn btn-primary btn-sm">アップロード</button>
          </div>
          <div class="col-md-5">
            <p id="file-error" class="error-message text-danger" style="display:none;"></p>
            <p class="help-block" tal:condition="form/image_file_name/hasError" tal:content="form/image_file_name/error">画像を入力してください。</p>
          </div>
        </div>
        <div class="form-group">
          <div class="col-md-offset-2 col-md-5">
            <input type="submit" value="送信" class="btn btn-primary btn-lg" />
          </div>
        </div>
      </fieldset>
    </form>

    <script type="text/javascript" src="/js/jquery.upload-1.0.2.js"></script>
    <script type="text/javascript">
    $(function() {

      var clearErrors = function() {
        $('#file-upload-fieldset').find('.error-message').hide();
        $('#file-input-show').parent().parent().removeClass('has-error');
        $('#file-error').hide();
      };

      // ファイルを選択
      $('#file-select').on('click', function() {
        $('#file-input').click();
      });

      // ファイル送信フォーム
      $('#file-input').on('change', function(){
        $('#file-input-show').val((window.File) ? this.files[0].name : $(this).val());
        clearErrors();
      });

      // ファイル表示フォーム
      $('#file-input-show').on('click', function() {
        $('#file-input').click();
      });

      // ファイル削除リンク
      $('#file-delete').on('click', function() {
        if (window.confirm('「' + $('#file-show img').attr('alt') + '」を削除します')) {
          $('input[name="upload_file"]').val('');
          $('#file-json').val('');
          $('#file-input-show').val('');
          $('#file-show').hide();
        }
      });

      // アップロードボタン
      $('#file-upload-button').on('click', function() {
        if ($('input[name="upload_file"]').val() == '') {
          $('#file-input-show').parent().parent().addClass('has-error');
          $('#file-error').text('ファイルを選択してください。').show();
          return;
        }
        var _self = this
        $('#file-upload-fieldset').upload('/uploader', function(result) {
          clearErrors();
          if (result.errors) {
            for (id in result.errors) {
              $('#file-input-show').parent().parent().addClass('has-error');
              $('#file-error').text(result.errors[id]).show();
            }
            return;
          }
          if (result.file.mimeType.substring(0, 5) == 'image' && result.data.dataUri) {
            $('#file-show img').attr('alt', result.file.name).attr('src', result.data.dataUri);
            $('#file-show').show();
          }
          $('#file-json').val(JSON.stringify(result.file));
        }, 'json');
      });

    });
    </script>

  </div>

  <footer class="footer">
    <p>Copyright &copy; 2013 k-holy &lt;k.holy74@gmail.com&gt; Code licensed under <a href="http://opensource.org/licenses/MIT">MIT</a></p>
  </footer>

</div>

</body>
</html>
